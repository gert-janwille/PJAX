'use strict';var Pjax={wrapper:'.pjax-wrapper',container:'.pjax-container',ignorePrefetchClass:'.no-prefetch',ignoreLinkClass:'.no-link',verbose:0,prefetch:!1,enableCache:!0,href:null,lastClickedElements:[],isAnimating:!1,animations:{},cache:{},status:{nDone:!1,oDone:!1},init:function init(){var _this2=this;var obj=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};$.map(obj,function(val,key){return _this2[key]=val});this.href=window.location.href;window.addEventListener('popstate',function(e){return _this2._popAction(e)});this._start()},_start:function _start(){var _this3=this;if(this.prefetch)this._prefetch();$('a').off().click(function(e){if(e.target.classList.contains(_this3.ignoreLinkClass.split('.').join("")))return;e.preventDefault();_this3._storeClickedElements(e.target);if(!_this3.isAnimating)_this3._trigger(e,e.target.href)})},animate:function animate(obj){this.animations=obj},_trigger:function _trigger(e,href){var _this4=this;if(!href)href=e.target;if(!href||this.href===href)return;history.pushState(null,null,href);this.href=href;this._loadContent(href).then(function(data){return _this4._replaceContent(data)})},_loadContent:function _loadContent(url){var _this5=this;if(this.cache[url])return new Promise(function(resolve){return resolve(_this5.cache[url])});this.verbose?console.log('Fetching '+url):null;return this._cachePages(url)},_replaceContent:function _replaceContent(data){var wrapper=$('<div></div>').append(data);var titleEl=wrapper.find('title');if(titleEl)document.title=titleEl[0].innerHTML;this.oldContainer=$(this.container);this.newContainer=wrapper.find(this.container);this._animate()},_animate:function _animate(){var _this6=this;this.isAnimating=!0;if(this.animations.start)this.animations.start(this);$(this.wrapper).append(this.newContainer);$(this.oldContainer).promise().done(function(){return _this6._done('oDone')});$(this.newContainer).promise().done(function(){return _this6._done('nDone')});this._start()},_prefetch:function _prefetch(prefetch){if(!this.enableCache)return;this.prefetch=null;if(this.verbose)console.log("Prefetching all pages...");var pageLinks=this._getLinks();this._crawlPages(pageLinks)},_crawlPages:function _crawlPages(links){var _this7=this;links.map(function(url){_this7._cachePages(url).then(function(data){var wrapper=$('<div></div>').append(data);var newLinks=_this7._getLinks(wrapper);if(!newLinks.length)return _this7.verbose?console.log('All pages Fetched',_this7.cache):null;newLinks.map(function(url){return!_this7.cache[url]?_this7._crawlPages(newLinks):null})}).catch(function(e){return console.error('Crawl Error',e)})})},_cachePages:function _cachePages(url){var _this8=this;return fetch(url,{method:'GET'}).then(function(r){return _this8.enableCache?_this8.cache[url]=r.text():r.text()}).catch(function(e){return console.error('Fetch Error',e)})},_getLinks:function _getLinks(data){var _this=this;var links=[];if(data)return this._getLinksFromData(data);$('a').each(function(){if($.inArray(this.href,links)===-1&&!this.classList.contains(_this.ignorePrefetchClass))links.push(this.href)});return links},_getLinksFromData:function _getLinksFromData(data){var _this=this;var links=[];data.find('a').each(function(){if($.inArray(this.href,links)===-1&&!this.classList.contains(_this.ignorePrefetchClass))links.push(this.href)});return links},_storeClickedElements:function _storeClickedElements(el){this.lastClickedElements.unshift(el.href);if(this.lastClickedElements.length>3)this.lastClickedElements.pop()},_popAction:function _popAction(e){var href=window.location.href;this.isAnimating=!1;this._trigger(e,href)},_done:function _done(key){this.status[key]=!0;if(this.status.nDone&&this.status.oDone){$(this.oldContainer).remove();this.isAnimating=!1;this.status={nDone:!1,oDone:!1}}}}
